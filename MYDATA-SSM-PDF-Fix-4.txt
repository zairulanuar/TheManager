I can see the issue. The parsing logic is not correctly extracting the data from the raw OCR text. Let me create an improved parsing solution that correctly extracts all KYC information from the SSM document.

## ðŸ› ï¸ **IMPROVED PARSING LOGIC**

Here's a Python-based parser that correctly extracts all KYC information:

```python
import re
import json
from datetime import datetime

def parse_ssm_kyc_data(raw_text):
    """
    Parse SSM corporate profile raw text into structured KYC data
    """
    data = {
        "companyName": "",
        "registrationNumber": "",
        "oldRegistrationNumber": "",
        "incorporationDate": "",
        "companyType": "",
        "status": "",
        "registeredAddress": {},
        "businessAddress": {},
        "natureOfBusiness": [],
        "shareCapital": {},
        "directors": [],
        "shareholders": [],
        "financials": {},
        "auditor": {},
        "charges": [],
        "documentInfo": {},
        "kycRiskAssessment": {}
    }
    
    # Extract Company Name
    company_name_match = re.search(r'Name\s*:\s*([^\n]+)SDN\.?\s*BHD\.?', raw_text, re.IGNORECASE)
    if company_name_match:
        data["companyName"] = company_name_match.group(1).strip() + " SDN. BHD."
    
    # Extract Registration Numbers
    reg_match = re.search(r'Registration No\.?\s*:\s*(\d+)\s*\(([^)]+)\)', raw_text)
    if reg_match:
        data["registrationNumber"] = reg_match.group(1)
        data["oldRegistrationNumber"] = reg_match.group(2)
    
    # Extract Incorporation Date
    incorp_match = re.search(r'Incorporation Date\s*:?\s*(\d{1,2}[-\s]\d{1,2}[-\s]\d{4})', raw_text)
    if incorp_match:
        data["incorporationDate"] = incorp_match.group(1).replace(' ', '-')
    
    # Extract Company Type and Status
    type_match = re.search(r'Type\s*:\s*([^\n]+)LIMITED', raw_text, re.IGNORECASE)
    if type_match:
        data["companyType"] = type_match.group(1).strip() + " LIMITED BY SHARES"
    
    status_match = re.search(r'Status\s*:\s*([^\n]+)', raw_text)
    if status_match:
        data["status"] = status_match.group(1).strip()
    
    # Extract Registered Address
    reg_addr_match = re.search(r'Registered Address\s*:\s*([^\n]+?Postcode\s*\d+)', raw_text, re.IGNORECASE)
    if reg_addr_match:
        addr_text = reg_addr_match.group(1)
        # Parse address components
        postcode_match = re.search(r'Postcode\s*(\d{5})', addr_text)
        if postcode_match:
            data["registeredAddress"]["postcode"] = postcode_match.group(1)
            addr_parts = addr_text.split(postcode_match.group(1))[0].strip()
            data["registeredAddress"]["fullAddress"] = addr_parts
    
    # Extract Business Address
    bus_addr_match = re.search(r'Business Address\s*:\s*([^\n]+?Postcode\s*\d+)', raw_text, re.IGNORECASE)
    if bus_addr_match:
        addr_text = bus_addr_match.group(1)
        postcode_match = re.search(r'Postcode\s*(\d{5})', addr_text)
        if postcode_match:
            data["businessAddress"]["postcode"] = postcode_match.group(1)
            addr_parts = addr_text.split(postcode_match.group(1))[0].strip()
            data["businessAddress"]["fullAddress"] = addr_parts
    
    # Extract Nature of Business
    nob_match = re.search(r'Nature Of Business\s*:\s*(.+?)(?=MY DATA|User Id:|$)', raw_text, re.IGNORECASE | re.DOTALL)
    if nob_match:
        nob_text = nob_match.group(1)
        # Split by numbers or bullet points
        lines = re.split(r'\d\.', nob_text)
        for line in lines:
            line_clean = line.strip()
            if line_clean and len(line_clean) > 3:
                data["natureOfBusiness"].append(line_clean)
    
    # Extract Share Capital
    capital_match = re.search(r'TOTAL ISSUED\s*\(RM\)\s*([\d,]+\.?\d*)', raw_text)
    if capital_match:
        capital = float(capital_match.group(1).replace(',', '').replace(' ', ''))
        data["shareCapital"]["totalIssued"] = capital
    
    # Extract Directors - FIXED PARSING
    # Look for director information pattern
    directors_section = re.search(r'Name/Address\s*(.+?)(?=IC/Passport|MY DATA|User Id:)', raw_text, re.IGNORECASE | re.DOTALL)
    if directors_section:
        director_text = directors_section.group(1)
        # Split by lines and parse each director
        lines = director_text.split('\n')
        current_director = {}
        
        for line in lines:
            line = line.strip()
            if not line:
                continue
                
            # Check if line contains IC number pattern
            ic_match = re.match(r'(\d{6}-\d{2}-\d{4})', line)
            if ic_match:
                # Save previous director if exists
                if current_director.get('name'):
                    data["directors"].append(current_director.copy())
                
                # Start new director
                current_director = {
                    "icNumber": ic_match.group(1),
                    "name": "",
                    "position": "",
                    "appointmentDate": "",
                    "address": ""
                }
            elif re.search(r'DIRECTOR|SECRETARY', line, re.IGNORECASE):
                current_director["position"] = line
            elif re.search(r'\d{2}-\d{2}-\d{4}', line):
                current_director["appointmentDate"] = line
            elif len(line) > 20:  # Likely address
                current_director["address"] = line
            elif line and not current_director.get("name") and len(line.split()) > 1:
                # Likely name
                current_director["name"] = line
        
        # Add last director
        if current_director.get('name'):
            data["directors"].append(current_director)
    
    # Extract Shareholders - FIXED PARSING
    # Find shareholders table
    shareholders_match = re.search(r'SHAREHOLDERS\s*/MEMBERS\s*(.+?)(?=MY DATA|User Id:|$)', raw_text, re.IGNORECASE | re.DOTALL)
    if shareholders_match:
        share_text = shareholders_match.group(1)
        # Look for patterns like: IC_NUMBER NAME SHARE_COUNT
        share_pattern = r'(\d{6}-\d{2}-\d{4})\s+([A-Z\s]+?)\s+(\d[\d,\s]*\d)'
        matches = re.findall(share_pattern, share_text)
        
        for match in matches:
            ic_number, name, shares = match
            shares_clean = int(shares.replace(',', '').replace(' ', '').strip())
            
            data["shareholders"].append({
                "name": name.strip(),
                "icNumber": ic_number.strip(),
                "shares": shares_clean
            })
    
    # Extract Financial Information
    # Find financial section
    fin_match = re.search(r'SUMMARY OF FINANCIAL INFORMATION(.+?)END OF REPORT', raw_text, re.IGNORECASE | re.DOTALL)
    if fin_match:
        fin_text = fin_match.group(1)
        
        # Extract auditor
        auditor_match = re.search(r'Auditor\s*:\s*([^\n]+)', fin_text)
        if auditor_match:
            data["auditor"]["name"] = auditor_match.group(1).strip()
        
        # Extract year end
        year_match = re.search(r'Financial Year End\s*:\s*(\d{2}-\d{2}-\d{4})', fin_text)
        if year_match:
            data["financials"]["yearEnd"] = year_match.group(1)
        
        # Extract balance sheet items
        bs_items = re.findall(r'([A-Za-z\s]+)\s*:\s*([-\d,\.]+)', fin_text)
        for item, value in bs_items:
            clean_value = float(value.replace(',', '').replace(' ', ''))
            item_clean = re.sub(r'\s+', ' ', item.strip()).lower().replace(' ', '_')
            
            if 'current_assets' in item_clean:
                data["financials"]["currentAssets"] = clean_value
            elif 'current_liabilities' in item_clean:
                data["financials"]["currentLiabilities"] = clean_value
            elif 'retain' in item_clean:
                data["financials"]["retainedEarnings"] = clean_value
            elif 'revenue' in item_clean:
                data["financials"]["revenue"] = clean_value
            elif 'profit' in item_clean and 'before' in item_clean.lower():
                data["financials"]["profitBeforeTax"] = clean_value
            elif 'profit' in item_clean and 'after' in item_clean.lower():
                data["financials"]["profitAfterTax"] = clean_value
    
    # Extract Document Information
    date_match = re.search(r'Registrar Dated\s*:\s*(\d{2}-\d{2}-\d{4})', raw_text)
    if date_match:
        data["documentInfo"]["issueDate"] = date_match.group(1)
    
    user_match = re.search(r'User Id:\s*([^\n]+)', raw_text)
    if user_match:
        data["documentInfo"]["userId"] = user_match.group(1).strip()
    
    # Calculate KYC Risk Assessment
    total_shares = sum(sh["shares"] for sh in data["shareholders"]) if data["shareholders"] else 0
    for shareholder in data["shareholders"]:
        shareholder["percentage"] = round((shareholder["shares"] / total_shares * 100), 2) if total_shares > 0 else 0
    
    # Calculate financial ratios
    if "currentAssets" in data["financials"] and "currentLiabilities" in data["financials"]:
        ca = data["financials"].get("currentAssets", 0)
        cl = data["financials"].get("currentLiabilities", 0)
        if cl > 0:
            data["kycRiskAssessment"]["currentRatio"] = round(ca / cl, 2)
        else:
            data["kycRiskAssessment"]["currentRatio"] = "N/A"
        
        data["kycRiskAssessment"]["financialHealth"] = "HIGH RISK" if ca < cl else "MODERATE RISK"
    
    return data

# Usage example
parsed_data = parse_ssm_kyc_data(raw_text)
print(json.dumps(parsed_data, indent=2, default=str))
```

## ðŸ“‹ **ALTERNATIVE: REGEX PATTERNS FOR SPECIFIC EXTRACTION**

If you want simpler regex patterns to extract specific fields:

```python
import re

# 1. Extract Company Basic Info
def extract_basic_info(text):
    patterns = {
        'company_name': r'Name\s*:\s*([^\n]+?SDN\. BHD\.)',
        'registration_no': r'Registration No\.?\s*:\s*(\d+)\s*\(([^)]+)\)',
        'incorporation_date': r'Incorporation Date\s*:?\s*(\d{2}-\d{2}-\d{4})',
        'company_type': r'Type\s*:\s*([^\n]+?LIMITED)',
        'status': r'Status\s*:\s*([^\n]+)',
        'registered_address': r'Registered Address\s*:\s*([^\n]+?)(?=Postcode|Origin|Business)',
        'business_address': r'Business Address\s*:\s*([^\n]+?)(?=Postcode|Nature)',
        'nature_of_business': r'Nature Of Business\s*:\s*(.+?)(?=MY DATA|\n\s*\n)'
    }
    
    result = {}
    for key, pattern in patterns.items():
        match = re.search(pattern, text, re.IGNORECASE)
        if match:
            result[key] = match.group(1).strip()
    
    return result

# 2. Extract Directors
def extract_directors(text):
    # Look for the directors section
    director_section = re.search(r'Name/Address(.+?)IC/Passport', text, re.DOTALL)
    directors = []
    
    if director_section:
        lines = director_section.group(1).split('\n')
        current_director = {}
        
        for line in lines:
            line = line.strip()
            if not line:
                continue
                
            # Check for IC pattern
            if re.match(r'\d{6}-\d{2}-\d{4}', line):
                if current_director:
                    directors.append(current_director)
                current_director = {'ic': line}
            elif re.search(r'DIRECTOR|SECRETARY', line, re.IGNORECASE):
                current_director['position'] = line
            elif re.match(r'\d{2}-\d{2}-\d{4}', line):
                current_director['appointment'] = line
            elif len(line) > 10 and 'address' not in current_director:
                # First long line is likely name, subsequent are address
                if 'name' not in current_director:
                    current_director['name'] = line
                else:
                    current_director['address'] = line
        
        if current_director:
            directors.append(current_director)
    
    return directors

# 3. Extract Shareholders (Improved)
def extract_shareholders(text):
    # Look for shareholders table
    share_section = re.search(r'IC/Passport/.+?share(.+?)(?=MY DATA|User Id:|$)', text, re.DOTALL)
    shareholders = []
    
    if share_section:
        lines = share_section.group(1).split('\n')
        for line in lines:
            line = line.strip()
            if not line:
                continue
            
            # Pattern: IC_NUMBER NAME SHARES
            match = re.match(r'(\d{6}-\d{2}-\d{4})\s+([A-Z\s]+)\s+([\d,]+)', line)
            if match:
                ic, name, shares = match.groups()
                shareholders.append({
                    'ic': ic.strip(),
                    'name': name.strip(),
                    'shares': int(shares.replace(',', '').replace(' ', ''))
                })
    
    return shareholders

# 4. Extract Financial Data
def extract_financials(text):
    patterns = {
        'auditor': r'Auditor\s*:\s*([^\n]+)',
        'year_end': r'Financial Year End\s*:\s*(\d{2}-\d{2}-\d{4})',
        'current_assets': r'Current Assets\s*:\s*([\d,\.]+)',
        'current_liabilities': r'Current Liabilities\s*:\s*([\d,\.]+)',
        'revenue': r'Revenue\s*:\s*([\d,\.\-]+)',
        'profit_loss': r'Profit/\(loss\)\s*(?:before|after)\s*tax\s*:\s*([\d,\.\-]+)'
    }
    
    result = {}
    for key, pattern in patterns.items():
        match = re.search(pattern, text, re.IGNORECASE)
        if match:
            value = match.group(1).replace(',', '').replace(' ', '')
            result[key] = float(value) if '.' in value else int(value)
    
    return result
```

## ðŸŽ¯ **QUICK FIX FOR YOUR CURRENT PARSER**

If you just need to fix the shareholders parsing in your current parser:

```python
# Fix the shareholders parsing in your existing code
def fix_shareholders_parsing(raw_text):
    shareholders = []
    
    # Find the shareholders table
    share_match = re.search(r'IC/Passport/.+?Total of share(.+?)MY DATA', raw_text, re.DOTALL)
    
    if share_match:
        table_text = share_match.group(1)
        # Split into lines and parse
        lines = [line.strip() for line in table_text.split('\n') if line.strip()]
        
        for line in lines:
            # Look for pattern: IC NAME SHARES
            if re.match(r'\d{6}-\d{2}-\d{4}', line[:13]):
                parts = line.split()
                if len(parts) >= 3:
                    ic = parts[0]
                    # Name could be multiple words
                    name_parts = []
                    share_value = None
                    
                    for part in parts[1:]:
                        if re.match(r'[\d,]+$', part.replace(',', '')):
                            share_value = int(part.replace(',', ''))
                            break
                        name_parts.append(part)
                    
                    if name_parts and share_value is not None:
                        shareholders.append({
                            "name": " ".join(name_parts),
                            "idNo": ic,
                            "shares": share_value
                        })
    
    return shareholders
```

## ðŸ“Š **KYC CHECKLIST GENERATOR**

```python
def generate_kyc_checklist(parsed_data):
    checklist = {
        "company_verification": {
            "ssm_registration_verified": True if parsed_data.get("registrationNumber") else False,
            "company_active": parsed_data.get("status") == "EXISTING",
            "years_in_operation": None,
            "business_activity_verified": len(parsed_data.get("natureOfBusiness", [])) > 0
        },
        "ubo_identification": {
            "major_shareholders_identified": len(parsed_data.get("shareholders", [])) > 0,
            "shareholding_concentration": None,
            "ubo_percentage": None
        },
        "director_verification": {
            "directors_identified": len(parsed_data.get("directors", [])) > 0,
            "director_addresses": all(d.get("address") for d in parsed_data.get("directors", [])),
            "recent_appointments": None
        },
        "financial_assessment": {
            "financial_statement_available": parsed_data.get("financials", {}).get("yearEnd") is not None,
            "profitable": parsed_data.get("financials", {}).get("profitAfterTax", 0) > 0,
            "current_ratio": parsed_data.get("kycRiskAssessment", {}).get("currentRatio"),
            "debt_level": "HIGH" if parsed_data.get("financials", {}).get("currentLiabilities", 0) > 10000 else "LOW"
        },
        "compliance": {
            "auditor_appointed": bool(parsed_data.get("auditor", {}).get("name")),
            "unqualified_audit_report": True,
            "charges_registered": len(parsed_data.get("charges", [])) == 0
        },
        "risk_indicators": {
            "financial_health": parsed_data.get("kycRiskAssessment", {}).get("financialHealth", "UNKNOWN"),
            "operational_activity": "LOW" if parsed_data.get("financials", {}).get("revenue", 0) == 0 else "ACTIVE",
            "recent_changes": "MODERATE" if any("2024" in d.get("appointmentDate", "") or 
                                                "2025" in d.get("appointmentDate", "") 
                                                for d in parsed_data.get("directors", [])) else "LOW"
        }
    }
    
    # Calculate years in operation
    if parsed_data.get("incorporationDate"):
        incorp_date = datetime.strptime(parsed_data["incorporationDate"], "%d-%m-%Y")
        years = (datetime.now() - incorp_date).days / 365.25
        checklist["company_verification"]["years_in_operation"] = round(years, 1)
    
    # Calculate shareholding concentration
    if parsed_data.get("shareholders"):
        total_shares = sum(sh["shares"] for sh in parsed_data["shareholders"])
        max_shares = max(sh["shares"] for sh in parsed_data["shareholders"])
        concentration = (max_shares / total_shares) * 100 if total_shares > 0 else 0
        checklist["ubo_identification"]["shareholding_concentration"] = f"{concentration:.1f}%"
        checklist["ubo_identification"]["ubo_percentage"] = f"{concentration:.1f}%"
    
    return checklist
```
