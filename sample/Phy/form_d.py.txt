from .rules_base import pick_new_no, pick_old_no, parse_date, normalize_text

def extract_form_d(lines: list) -> dict:
    blocks = [ln for ln in lines if ln.strip()]
    text = normalize_text("\n".join(blocks))
    fields = {
        "doc_type": "FORM_D",
        "entity_name": None,
        "business_type": "Enterprise",
        "registration_number_new": pick_new_no(text),
        "registration_number_old": pick_old_no(text),
        "incorporation_or_registration_date": None,
        "valid_until": None,
        "registered_address": None,
        "branch_addresses": [],
        "issue_place": None,
        "issue_date": None,
        "signing_officer": None
    }

    # Entity name line usually after "under the name"
    for i, ln in enumerate(blocks):
        if "under the name" in ln.lower():
            # Check same line first
            parts = ln.split("under the name", 1) # case-insensitive approx
            if len(parts) == 1:
                lower_ln = ln.lower()
                idx = lower_ln.find("under the name")
                if idx != -1:
                    candidate = ln[idx + len("under the name"):].strip()
                else:
                    candidate = ""
            else:
                candidate = parts[1].strip()

            if not candidate or len(candidate) < 3:
                 if i+1 < len(blocks): candidate = blocks[i+1].strip()
            
            if candidate:
                 fields["entity_name"] = candidate.strip(" :.-")
            break
    if not fields["entity_name"]:
        # fallback: longest ALLCAPS line
        caps = [ln for ln in blocks if ln.strip().isupper() and len(ln.strip()) > 5]
        fields["entity_name"] = sorted(caps, key=len, reverse=True)[0] if caps else None

    # Dates & addresses
    for i, ln in enumerate(blocks):
        low = ln.lower()
        if "registered until" in low:
            fields["valid_until"] = parse_date(ln)
        if low.startswith("dated at"):
            fields["issue_date"] = parse_date(ln)
            # capture place after "dated at"
            parts = ln.split(" ", 3)
            if len(parts) >= 3:
                fields["issue_place"] = parts[2].strip(",.")
        
        # Address extraction
        # "place of business at" might be split as "principle place" / "of business at"
        if "place of business at" in low or "of business at" in low:
            # Avoid re-capturing if we already found it (unless it's a better match?)
            # But usually it appears once.
            # We must be careful not to match "branch at" here if it was "place of business at" only.
            # But "of business at" is safe.
            
            if fields["registered_address"]:
                # already found, skip
                pass
            else:
                addr_parts = []
                
                # Check if there is text on the same line after "at"
                if " at" in ln:
                    remainder = ln.split(" at", 1)[-1].strip(" :-")
                    # If line is just "of business at 12.", remainder is "12."
                    if remainder:
                        addr_parts.append(remainder)
                
                # Capture subsequent lines until a stop phrase is found
                j = i + 1
                while j < len(blocks):
                    next_ln = blocks[j].strip()
                    next_low = next_ln.lower()
                    
                    # Stop conditions
                    if "has been registered" in next_low: break
                    if "registered until" in next_low: break
                    if "dated at" in next_low: break
                    if "certificate of registration" in next_low: break
                    if "section 11" in next_low: break 
                    
                    if "and branch at" in next_low:
                        break
                        
                    addr_parts.append(next_ln)
                    j += 1
                
                if addr_parts:
                    fields["registered_address"] = ", ".join(addr_parts)

        if "and branch at" in low:
            br_parts = []
            # Capture same line
            remainder = ln.split(" at",1)[-1].strip(" :-")
            if remainder:
                br_parts.append(remainder)
            
            # Capture subsequent lines
            j = i + 1
            while j < len(blocks):
                next_ln = blocks[j].strip()
                next_low = next_ln.lower()
                
                if "dated at" in next_low: break
                if "registrar of businesses" in next_low: break
                
                br_parts.append(next_ln)
                j += 1
            
            if br_parts:
                full_br = ", ".join(br_parts)
                fields["branch_addresses"].append(full_br)

        if "registrar of businesses" in low:
            fields["signing_officer"] = ln.strip()

    # Registration date fallback = issue date (common on Form D)
    if not fields["incorporation_or_registration_date"]:
        fields["incorporation_or_registration_date"] = fields["issue_date"]

    return fields
